from django.shortcuts import render
from django.views.generic import TemplateView
import requests
import sqlite3
import json
import os



query = """ CREATE TABLE test (Scan_Id VARCHAR(20), Sha1 VARCHAR(20), resource VARCHAR(20), Response_Code VARCHAR(20), Sha256 VARCHAR(20),
 Permalink VARCHAR(20), Md5 VARCHAR(20));"""
# con = sqlite3.connect('db.sqlite3')
# con.execute(query)
# con.commit()

# Create your views here.
def home(request):
    return render(request, 'index1.html')

def new(request):
    if request.method == 'POST':
        file = request.FILES['myfile']


        file_scan = 'https://www.virustotal.com/vtapi/v2/file/scan'
        file_report = 'https://www.virustotal.com/vtapi/v2/file/report'




        params = {'apikey': '7ebccd85b709bed624bb25e890ff9196836f31807a57d9a58d1982c62cfc4470'}

        files = {'file': file}

        response = requests.post(file_scan, files=files, params=params)

        file_scan_data = response.json()
        # Data variables
        scan_id = file_scan_data['scan_id']
        sha1 = file_scan_data['sha1']
        resource = file_scan_data['resource']
        response_code = file_scan_data['response_code']
        sha256 = file_scan_data['sha256']
        permalink = file_scan_data['permalink']
        md5 = file_scan_data['md5']
        # End of data Variables

        params1 = {'apikey': '7ebccd85b709bed624bb25e890ff9196836f31807a57d9a58d1982c62cfc4470', 'resource': md5}

        response1 = requests.get(file_report, params=params1)

        file_report_data = response1.json()
        
        detected = file_report_data['scans']['McAfee']['detected']
        version = file_report_data['scans']['McAfee']['version']
        result = file_report_data['scans']['McAfee']['result']
        update = file_report_data['scans']['McAfee']['update']
        scan_date = file_report_data['scan_date']


        alldata = {'mydata': file_scan_data,'detected': detected,'version':version,'result':result,'update':update, 'md5': md5,'mcafee':mcafee,'scan_date':scan_date,'scan_id':scan_id, 'sha1':sha1, 'resource':resource,
                   'response_code':response_code,'sha256':sha256,'permalink':permalink}

        # connection = sqlite3.connect('db.sqlite3')
        # data = [(scan_id,sha1,resource,response_code,sha256,permalink,md5)]
        # statement = "INSERT INTO test VALUES(?,?,?,?,?,?,?)"
        # connection.executemany(statement,data)
        # connection.commit()
        # connection.close()

    return render(request, 'Virus_Total.html',alldata)

def cuckoo(request):
    if request.method == 'POST':
        file = request.FILES['myfile']

        create_file_url = "http://localhost:8090/tasks/create/file"
        file_submit = "http://localhost:8090/tasks/create/submit"
        create_list = "http://localhost:8090/tasks/list/"
        sample = "http://localhost:8090/tasks/sample/1"
        # report = "http://localhost:8090/tasks/report/1"
        summary = "http://localhost:8090/tasks/summary/1"


        HEADERS = {"Authorization": "Bearer tnrlQMr-UQtgRQ8GPmwWVw"}

        files = {'file': file}

        r = requests.post(create_file_url, headers=HEADERS, files=files)
        r1 = requests.post(file_submit, files=files, headers=HEADERS)
        r2 = requests.get(create_list, headers=HEADERS)
        r3 = requests.get(sample, headers=HEADERS)
        r4 = request.get(summary, headers=HEADERS)

        # response4 = request.post(sample, )
        # report_response = request.post(report, submit_id)


        r1_data = r.json()['task_id']
        submit_id = r1.json()["submit_id"]
        task_ids = r1.json()["task_ids"]
        errors = r1.json()["errors"]
        r2_data = r2.json()
        sample_result = r3.json()
        summary = r4.json()
        # report = report_response.json()


        alldata = {'mydata': r1_data, 'submit_id':submit_id,  'task_id':task_ids, 'errors':errors, 'list_data':r2_data, 'sample_result':sample_result, 'summary':summary}


        # ........................sqlite coding........................

        # data = [(a, b, c, d)]
        # stmt = "INSERT INTO test VALUES(?, ?, ?,?)"
        # con.executemany(stmt,data2)
        # con.commit()







    return render(request, 'cuckoo.html',  alldata)

